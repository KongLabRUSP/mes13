---
title: "DNA methylome and transcriptome alterations in a high-glucose induced diabetic nephropathy cellular model and identification of novel targets for treatment by Tanshinone IIA "
output:
  html_notebook:
    highlight: tango
    number_sections: no
    theme: united
    toc: TRUE
    toc_float: TRUE
    df_print: paged
    code_folding: hide
---
Last Run: `r date()`  
    
Wenji Li^a,b,c^, Davit Sargsyan^c,d,e^, Renyi Wu^c,d^, Shanyi Li^c,d^, Lujing Wang^c,d,e^, Ah-Ng Kong^c,d^  
    
^a^ Institute of Translational Medicine, Medical College, Yangzhou University, Yangzhou, 225001, PR China    
^b^ Jiangsu Key laboratory of integrated traditional Chinese and Western Medicine for prevention and treatment of Senile Diseases, Yangzhou University, Yangzhou, 225001, PR China    
^c^ Department of Pharmaceutics, Ernest Mario School of Pharmacy, Rutgers, The State University of New Jersey, 160 Frelinghuysen Road, Piscataway, NJ 08854, USA     
^d^ Center for Phytochemical Epigenome Studies, Ernest Mario School of Pharmacy, The State University of New Jersey, Piscataway, NJ 08854, USA          
^e^ Graduate Program in Pharmaceutical Sciences, Ernest Mario School of Pharmacy, The State University of New Jersey, Piscataway, NJ 08854, USA          


   
# Setup
```{r setup,echo = FALSE, message = FALSE, error = FALSE, warning = FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	message = FALSE
)

require(data.table)
require(DT)
require(ggplot2)
require(DESeq2)
require(DEGseq)
require(knitr)
require(ggdendro) 
require(ggforce)
require(gridExtra)
```

# RNA-seq Data
## Load RNA Data
```{r data_rna, paged.print=TRUE}
# Treatment legend----
trt.names <- c("LG",
               "HG",
               "MIC_1.5uM",
               "TIIA_5uM",
               "FX_1uM",
               "Gen_10uM",
               "Ber_6uM")

# Load data----
# Question to Renyi: how was the data processed and annotated?
# dt1 <- fread("data/Renyi_RNAseq_12292017/mes13_fpkm_Dec2017_david.csv")
# dt1 <- fread("data/Renyi_RNAseq_12292017/mes13_featurecounts_Dec2017_david.csv")
# dt1 <- fread("data/rna_seq/Renyi_12292017/mes13_featurecounts_Dec2017_david.csv")
dt1 <- fread("data/Renyi_RNAseq_12292017/mes13_featurecounts_Dec2017_david.csv")

# Keep only gene IDs and counts
dt1 <- dt1[, c("Geneid",
               "WJ1.dedup.bam",
               "WJ2.dedup.bam",
               "WJ3.dedup.bam",
               "WJ4.dedup.bam",
               "WJ5.dedup.bam",
               "WJ6.dedup.bam",
               "WJ7.dedup.bam")]
colnames(dt1) <- c("GeneNames",
                   trt.names)

datatable(head(dt1))
```

## Remove genes with low counts
```{r remove_low_counts}
tmp <- rowSums(dt1[, -1])
# Remove if total across 3 samples is no more than 10
dt1 <- droplevels(subset(dt1,
                         tmp > 20))
print("13,954 genes left, down from 24,421 genes")

# Leave the 3 treatments only----
dt1 <- subset(dt1,
              select = c("GeneNames",
                         "LG",
                         "HG",
                         "TIIA_5uM"))
datatable(head(dt1))
```

## Normalize to Fragments per Million (FPM)
```{r norm_fpm}
mat <- data.frame(sample = colnames(dt1)[-1],
                  trt = colnames(dt1)[-1],
                  repl = factor(rep(1, ncol(dt1) - 1)))
datatable(mat)

dtm <- as.matrix(dt1[, -1, with = FALSE])
rownames(dtm) <- dt1$GeneNames
datatable(head(dtm,
               10))

dds <- DESeqDataSetFromMatrix(countData = dtm, 
                              colData = mat,
                              ~ trt)
dds <- estimateSizeFactors(dds)
dds

# Fragments per million (FPM) normalization----
dt1.fpm <- data.table(GeneNames = dt1$GeneNames,
                      fpm(dds,
                          robust = FALSE))
colnames(dt1.fpm)[-1] <- paste(colnames(dt1.fpm)[-1],
                               "fpm",
                               sep = "_")
datatable(head(dt1.fpm, 
               10))%>% 
  formatCurrency(columns = 1:ncol(dt1.fpm),
                 currency = "",
                 digits = 2)
```

# Differential Expressions
## HG - LG
```{r degseq_hg_lg}
DEGexp(geneExpMatrix1 = dt1,
       geneCol1 = which(colnames(dt1) == "GeneNames"), 
       expCol1 = which(colnames(dt1) == "HG"), 
       groupLabel1 = "HG",
       
       geneExpMatrix2 = dt1,
       geneCol2 = which(colnames(dt1) == "GeneNames"), 
       expCol2 = which(colnames(dt1) == "LG"),
       groupLabel2 = "LG",
       
       foldChange = 2^0.3,
       qValue = 0.5,
       thresholdKind = 5, 
       rawCount = TRUE,
       normalMethod = "none",
       method = "MARS",
       outputDir = "tmp/hg_lg")

hg_lg <- fread("tmp/hg_lg/output_score.txt")
hg_lg
# CHECK:
hg_lg[hg_lg$GeneNames == "Nmu", ]
hg_lg[hg_lg$`Signature(q-value(Storey et al. 2003) < 0.5)`,]

# Write as CSV----
write.csv(hg_lg,
          file = "tmp/hg_lg/MES13_RNA_DEGseq_HG-LG.csv",
          row.names = FALSE)

# MA Plot----
hg_lg <- merge(hg_lg,
               dt1.fpm,
               by = "GeneNames")
hg_lg[, mu := (log2(HG_fpm + 1) + log2(LG_fpm + 1))/2]
hg_lg[, diff := log2(HG_fpm + 1) - log2(LG_fpm + 1)]

tiff(filename = "tmp/hg_lg/fig1a_mes13_hg_lg_maplot.tiff",
     height = 6,
     width = 6,
     units = 'in',
     res = 600,
     compression = "lzw+p")
plot(hg_lg$diff ~ hg_lg$mu,
     pch = ".",
     xlab = "Mean",
     ylab = "Difference",
     ylim = c(-3.2, 3.2),
     main = "MES13 FPM-Normalized Gene Expressions\nHG-LG, FDR < 0.5")
points(hg_lg$diff[hg_lg$`q-value(Storey et al. 2003)` < 0.5 & hg_lg$diff > 0] ~ hg_lg$mu[hg_lg$`q-value(Storey et al. 2003)` < 0.5 & hg_lg$diff > 0] ,
       pch = "x",
       col = "green")
points(hg_lg$diff[hg_lg$`q-value(Storey et al. 2003)` < 0.5 & hg_lg$diff < 0] ~ hg_lg$mu[hg_lg$`q-value(Storey et al. 2003)` < 0.5 & hg_lg$diff < 0] ,
       pch = "x",
       col = "red")
abline(h = c(-0.3, 0.3),
       lty = 2)
graphics.off()
```

## TIIA - HG
```{r degseq_tiia_hg}
DEGexp(geneExpMatrix1 = dt1,
       geneCol1 = which(colnames(dt1) == "GeneNames"), 
       expCol1 = which(colnames(dt1) == "TIIA_5uM"), 
       groupLabel1 = "TIIA_5uM",
       
       geneExpMatrix2 = dt1,
       geneCol2 = which(colnames(dt1) == "GeneNames"), 
       expCol2 = which(colnames(dt1) == "HG"),
       groupLabel2 = "HG",
       
       foldChange = 2^0.3,
       qValue = 0.5,
       thresholdKind = 5, 
       rawCount = TRUE,
       normalMethod = "none",
       method = "MARS",
       outputDir = "tmp/tiia_hg")

tiia_hg <- fread("tmp/tiia_hg/output_score.txt")
tiia_hg
#CHECK:
tiia_hg[tiia_hg$GeneNames == "Nmu"]
tiia_hg[tiia_hg$`Signature(q-value(Storey et al. 2003) < 0.5)`, ]

# Write as CSV----
write.csv(tiia_hg,
          file = "tmp/tiia_hg/MES13_RNA_DEGseq_TIIA-HG.csv",
          row.names = FALSE)

# MA Plot----
tiia_hg <- merge(tiia_hg,
                 dt1.fpm,
                 by = "GeneNames")
tiia_hg[, mu := (log2(TIIA_5uM_fpm + 1) + log2(HG_fpm + 1))/2]
tiia_hg[, diff := log2(TIIA_5uM_fpm + 1) - log2(HG_fpm + 1)]

tiff(filename = "tmp/tiia_hg/fig1b_mes13_tiia_hg_maplot.tiff",
     height = 6,
     width = 6,
     units = 'in',
     res = 600,
     compression = "lzw+p")
plot(tiia_hg$diff ~ tiia_hg$mu,
     pch = ".",
     xlab = "Mean",
     ylab = "Difference",
     ylim = c(-3.2, 3.2),
     main = "MES13 FPM-Normalized Gene Expressions\nTIIA-HG, FDR < 0.5")
points(tiia_hg$diff[tiia_hg$`q-value(Storey et al. 2003)` < 0.5 & tiia_hg$diff > 0] ~ tiia_hg$mu[tiia_hg$`q-value(Storey et al. 2003)` < 0.5 & tiia_hg$diff > 0] ,
       pch = "x",
       col = "green")
points(tiia_hg$diff[tiia_hg$`q-value(Storey et al. 2003)` < 0.5 & tiia_hg$diff < 0] ~ tiia_hg$mu[tiia_hg$`q-value(Storey et al. 2003)` < 0.5 & tiia_hg$diff < 0] ,
       pch = "x",
       col = "red")
abline(h = c(-0.3, 0.3),
       lty = 2)
graphics.off()
```

# Venn Diagramms
```{r venn, fig.height = 10, fig.width = 8}
g1 <- hg_lg[`q-value(Storey et al. 2003)` < 0.5 & 
              `log2(Fold_change) normalized` > 0.3,]$GeneNames
# 263 genes
g2 <- hg_lg[`q-value(Storey et al. 2003)` < 0.5 & 
              `log2(Fold_change) normalized` < -0.3,]$GeneNames
# 207 genes

g3 <- tiia_hg[`q-value(Storey et al. 2003)` < 0.5 & 
                `log2(Fold_change) normalized` > 0.3,]$GeneNames
# 1,120 genes
g4 <- tiia_hg[`q-value(Storey et al. 2003)` < 0.5 & 
                `log2(Fold_change) normalized` < -0.3,]$GeneNames
# 1,393 genes

up.dn <- g1[g1 %in% g4]
# 124 genes
dn.up <- g2[g2 %in% g3]
# 89 genes

p1 <- ggplot() +
  geom_circle(aes(x0 = c(1, 2, 1, 2),
                  y0 = c(1, 1, 4, 4),
                  r = rep(1, 4),
                  color = factor(c(2, 1, 1, 2))),
              size = 2) +
  geom_text(aes(x = rep(c(0.5, 1.5, 2.5), 2),
                y = rep(c(1.1, 4.1), each = 3),
                label = format(c(118, 89, 1031,
                                 139, 124, 1269),
                               big.mark = ",")),
            size = 7) +
  geom_text(aes(x = c(1, 2, 1, 2),
                y = c(2.3, 2.3, 5.3, 5.3),
                label = c("HG vs. LG\n(263)",
                          "TIIA vs. HG\n(1,393)",
                          "HG vs. LG\n(207)",
                          "TIIA vs. HG\n(1,120)"),
                color = factor(c(2, 1, 1, 2))),
            size = 7) +
  geom_text(aes(x = c(3.25, 3.25),
                y = c(1.1, 4.1),
                label = c("1,532",
                          "1,238")),
            size = 7) +
  scale_x_continuous(limits = c(0, 4)) +
  scale_color_manual(values = c("green", "red")) +
  theme_void() +
  theme(legend.position = "none")

tiff(filename = "tmp/fig3_mes13_venn.tiff",
     height = 10,
     width = 8,
     units = 'in',
     res = 600,
     compression = "lzw+p")
plot(p1)
graphics.off()

print(p1)
```

```{r heatmap, fig.height = 12, fig.width = 12}
ll <- unique(c(up.dn,
               dn.up))

t1 <- merge(hg_lg[hg_lg$GeneNames %in% ll, 
                  c("GeneNames",
                    "log2(Fold_change) normalized")],
            tiia_hg[tiia_hg$GeneNames %in% ll, 
                    c("GeneNames",
                      "log2(Fold_change) normalized")],
            by = "GeneNames")
colnames(t1) <- c("Gene",
                  "HG-LG",
                  "TIIA-HG")
t1 <- t1[order(t1$`HG-LG`,
               decreasing = TRUE), ]

# Nmu     4.128832   -0.8490297
write.csv(t1,
          file = "tmp/mes13_tiia_rnaseq_degseq_genes_q-0.5_log2-0.3.csv",
          row.names = FALSE)

ll <- melt.data.table(data = t1,
                      id.vars = 1,
                      measure.vars = 2:3,
                      variable.name = "Comparison",
                      value.name = "Gene Expression Diff")
ll$Comparison <- factor(ll$Comparison,
                        levels = c("TIIA-HG", 
                                   "HG-LG"))
lvls <- ll[ll$Comparison == "HG-LG", ]
ll$Gene <- factor(ll$Gene,
                  levels = lvls$Gene[order(lvls$`Gene Expression Diff`)])

# Add dendrogram----
# Sources: 
# https://stackoverflow.com/questions/43794870/plotting-a-clustered-heatmap-with-dendrograms-using-rs-plotly
# https://stats.stackexchange.com/questions/4062/how-to-plot-a-fan-polar-dendrogram-in-r
# https://cran.r-project.org/web/packages/ggdendro/vignettes/ggdendro.html
# http://www.sthda.com/english/wiki/beautiful-dendrogram-visualizations-in-r-5-must-known-methods-unsupervised-machine-learning
dt.dndr <- data.frame(t1[Gene %in% levels(ll$Gene), ])
rownames(dt.dndr) <- dt.dndr$Gene
dt.dndr <- dt.dndr[, -1]

# Compute distances between genes----
sampleDists <- dist(dt.dndr)
# Make dendrogram data----
dhc <- as.dendrogram(hclust(d = sampleDists),
                     horiz = TRUE)
ddata <- dendro_data(dhc, 
                     type = "rectangle")

# Segment data----
dtp1 <- segment(ddata)

# Hitmap data----
dtp2 <- ll
dtp2$Gene <- factor(dtp2$Gene,
                    levels = ddata$labels$label)
offset.size <- 10

p2 <- ggplot(data = dtp2) +
  coord_polar("y",
              start = 0,
              direction = -1) +
  geom_tile(aes(x =  as.numeric(Comparison),
                y = Gene, 
                fill = `Gene Expression Diff`),
            color = "white") +
  # geom_text(data = dtp2[Comparison == "HG-LG", ],
  #           aes(x = rep(2.25,
  #                       nlevels(Gene)),
  #               y = Gene,
  #               angle = 90 + seq(from = 0,
  #                                to = 360,
  #                                length.out = nlevels(Gene))[as.numeric(Gene)] +
  #                 offset.size,
  #               label = 1:nlevels(Gene)),
  #           hjust = 0,
  #           size = 6) +
geom_text(data = dtp2[Comparison == "HG-LG", ],
          aes(x = rep(1.75,
                      nlevels(Gene)),
              y = Gene,
              angle = 90 + seq(from = 10,
                               to = 350,
                               length.out = nlevels(Gene))[as.numeric(Gene)] + 
                offset.size,
              label = unique(Gene)),
          hjust = 0) +
  geom_text(data = dtp2[Gene == levels(dtp2$Gene)[1], ],
            aes(x = 1:nlevels(Comparison),
                y = rep(-offset.size,
                        nlevels(Comparison)),
                angle = 0,
                label = levels(Comparison)),
            hjust = 1,
            size = 8) +
  scale_fill_gradient2(low = "red", 
                       high = "green", 
                       mid = "grey", 
                       midpoint = 0, 
                       name = "") +
  scale_y_discrete("",
                   expand = c(0, 0)) +
  theme(plot.title = element_text(hjust = 0.5),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 25),
        legend.direction = "horizontal",
        legend.key.width = unit(1.5, "in"),
        legend.key.height = unit(0.5, "in")) +
  geom_segment(data = dtp1,
               aes(x = -sqrt(y) + 0.5,
                   y = x, 
                   xend = -sqrt(yend) + 0.5,
                   yend = xend),
               size = 1) 

tiff(filename = "tmp/mes13_tiia_hitmap_with_phylo.tiff",
     height = 12,
     width = 12,
     units = 'in',
     res = 600,
     compression = "lzw+p")
print(p2)
graphics.off()

print(p2)
```

```{r heatmap-venn, fig.height = 10, fig.width = 18}
# # Blank canvas
# p3 <- ggplot() + theme_void()

tiff(filename = "tmp/mes13_tiia_hitmap_with_phylo_and_venn.tiff",
     height = 10,
     width = 18,
     units = 'in',
     res = 600,
     compression = "lzw+p")
print(grid.arrange(p2, 
                   p1,
                   # arrangeGrob(p3, p1, p3,
                   #             ncol = 1,
                   #             heights = c(1, 8, 1)), 
                   nrow = 1, 
                   heights = 10, 
                   widths = c(10, 8)))
graphics.off()

print(grid.arrange(p2, 
                   p1,
                   nrow = 1, 
                   heights = 10, 
                   widths = c(10, 8)))
```


# Appendix
## Sources

## References

## Session Info
```{r}
sessionInfo()
```